<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Salvando el Mar - Marinero</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CONFIGURACIÃ“N TAILWIND: Registramos la fuente Pixelify -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              pixel: ['"Pixelify Sans"', 'cursive', 'sans-serif'],
            },
          },
        },
      }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* GLOBAL STYLES & RESET */
      html, body {
        margin: 0;
        padding: 0;
        background-color: #020617; /* Slate 950 */
        font-family: 'Pixelify Sans', cursive, sans-serif !important;
        touch-action: none; /* Prevent scroll/zoom on mobile */
        overflow: hidden; 
        width: 100%;
        height: 100%;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      #root {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      canvas {
        image-rendering: pixelated; /* Essential for retro pixel art look */
        display: block;
      }
      
      /* Retro Scanline Effect */
      .scanline {
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
        background-size: 100% 4px;
        position: absolute;
        top: 0; right: 0; bottom: 0; left: 0;
        pointer-events: none;
        z-index: 50;
      }

      .text-shadow-retro {
        text-shadow: 2px 2px 0px #000;
      }

      /* Button interactions override for pixel boxes */
      .btn-pixel-wrapper:active .pixel-inner {
        transform: translateY(4px);
      }
      .btn-pixel-wrapper:active {
        /* Remove native shadow/transform on container if any */
        transform: none; 
      }

      /* Heartbeat Animation for Logo */
      @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      .animate-logo-pulse {
        animation: heartbeat 2s infinite ease-in-out;
      }

      /* --- NUEVO: PIXEL ART CORNERS (Escalonado) --- */
      /* Esto recorta las esquinas en forma de "muesca" de 4px */
      .pixel-clip {
        clip-path: polygon(
          0px 4px, 4px 4px, 4px 0px,
          calc(100% - 4px) 0px, calc(100% - 4px) 4px, 100% 4px,
          100% calc(100% - 4px), calc(100% - 4px) calc(100% - 4px), calc(100% - 4px) 100%,
          4px 100%, 4px calc(100% - 4px), 0px calc(100% - 4px)
        );
      }
    </style>
    
    <!-- ROBUST IMPORT MAP: STRICTLY REACT 18 -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Trash2, Award, Play, RotateCcw, ChevronLeft, ChevronRight, ArrowUp, Skull } from 'lucide-react';

        // ==========================================
        // 1. ASSETS & CONSTANTS
        // ==========================================
        
        const GAME_ASSETS = {
            LOGO: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/logo1.png",
            PLAYER: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/MateoPlayer.gif",
            
            // AUDIO
            MUSIC_BG: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/408efe5d77d229042ea878ad5cdd219df39c73ce/Untitled.mp3",
            SFX_COLLECT: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/ec7e957306cc84aaca09b7ae617afd65bf33f921/obj.wav",
            SFX_EXPLOSION: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/ec7e957306cc84aaca09b7ae617afd65bf33f921/explosion.wav",

            // BASURA
            TRASH_BOTTLE: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/botella.png",
            TRASH_BAG: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/bolsa.png",
            TRASH_TIRE: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/llanta.png",
            TRASH_BOOT: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/bota.png",

            // ENEMIGOS
            ENEMY_JELLYFISH: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/medusa.png",
            ENEMY_SHARK: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/tiburon.png",
            
            // FONDO
            BG_LAYER: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/fondo1.png",

            // DECORACIÃ“N
            DECO_ALGA_1: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/alga1.png",
            DECO_ALGA_2: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/alga2.png",
            DECO_ALGA_3: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/alga3.png",
            DECO_CORAL_1: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral1.png",
            DECO_CORAL_2: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral2.png",
            DECO_CORAL_3: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral3.png",
            DECO_CORAL_4: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral4.png",
            DECO_CORAL_5: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/coral5.png",
            DECO_ROCK_1: "https://raw.githubusercontent.com/nsanchezBG/MarineroSTSBG/main/roca1.png"
        };

        const CUSTOM_MESSAGES = [
            { title: "Marinero de Agua Dulce", message: "Â¡Buen inicio! Pero el mar necesita mÃ¡s limpieza." },
            { title: "Grumete Reciclador", message: "Â¡Bien hecho! Esa basura ya no daÃ±arÃ¡ a las tortugas." },
            { title: "CapitÃ¡n del Arrecife", message: "Â¡IncreÃ­ble! Tu red estÃ¡ llena de buenas acciones." },
            { title: "Almirante EcolÃ³gico", message: "Â¡El ocÃ©ano te saluda! Una puntuaciÃ³n legendaria." },
            { title: "PoseidÃ³n de la Limpieza", message: "Â¡Nadie cuida el mar mejor que tÃº!" }
        ];

        const LOGICAL_WIDTH = 450; 
        const LOGICAL_HEIGHT = 800;
        
        const GRAVITY = 0.25;
        const SWIM_FORCE = -7; 
        const FRICTION = 0.96;
        
        const COLORS = {
            BRAND_RED: '#dc2626',
            BRAND_YELLOW: '#facc15',
            BRAND_BLUE_LIGHT: '#38bdf8',
            BRAND_BLUE_DARK: '#0369a1',
            SAND: '#fcd34d',
            BUBBLE: 'rgba(255, 255, 255, 0.6)'
        };

        // ==========================================
        // 2. COMPONENT: GAME CANVAS
        // ==========================================

        const GameCanvas = ({ status, onScoreUpdate, onGameOver, playSfx, sessionId }) => {
            const canvasRef = useRef(null);
            const domPlayerRef = useRef(null);
            const requestRef = useRef(0);
            const frameCountRef = useRef(0);
            const facingRef = useRef('RIGHT');
            const [images, setImages] = useState({});
            const nextDecoSpawnRef = useRef(30);
            
            // KEYBOARD INPUT STATE (Persistent)
            const keysRef = useRef(new Set());

            // --- 2a. Load Assets ---
            useEffect(() => {
                const loaded = {};
                // Filter out audio assets
                const keys = Object.keys(GAME_ASSETS).filter(k => k !== 'PLAYER' && !k.startsWith('MUSIC') && !k.startsWith('SFX'));
                let count = 0;
                
                if (keys.length === 0) return;

                keys.forEach(key => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.src = GAME_ASSETS[key];
                    img.onload = () => { 
                        loaded[key] = img; 
                        count++; 
                        if(count === keys.length) setImages(loaded); 
                    };
                    img.onerror = () => { 
                        console.warn('Error loading asset:', key); 
                        count++; 
                        if(count === keys.length) setImages(loaded); 
                    };
                });
            }, []);

            // --- 2b. Game State ---
            const gameState = useRef({
                player: { x: 50, y: LOGICAL_HEIGHT/2, vx: 0, vy: 0, width: 80, height: 80, invincible: 0 },
                entities: [],
                decorations: [],
                particles: [],
                score: 0
            });

            // --- 2c. Input Listeners ---
            useEffect(() => {
                const down = (e) => keysRef.current.add(e.key);
                const up = (e) => keysRef.current.delete(e.key);
                // Custom events for touch controls
                const touchDown = (e) => keysRef.current.add(e.detail.key);
                const touchUp = (e) => keysRef.current.delete(e.detail.key);

                window.addEventListener('keydown', down);
                window.addEventListener('keyup', up);
                window.addEventListener('game-input-down', touchDown);
                window.addEventListener('game-input-up', touchUp);

                return () => {
                    window.removeEventListener('keydown', down);
                    window.removeEventListener('keyup', up);
                    window.removeEventListener('game-input-down', touchDown);
                    window.removeEventListener('game-input-up', touchUp);
                };
            }, []);
            
            // --- 2d. Reset Logic (FIXED) ---
            useEffect(() => {
                 gameState.current = {
                    player: { x: 50, y: LOGICAL_HEIGHT/2, vx: 0, vy: 0, width: 80, height: 80, invincible: 0 },
                    entities: [],
                    decorations: [],
                    particles: [],
                    score: 0
                };
                frameCountRef.current = 0;
                nextDecoSpawnRef.current = 30;
                onScoreUpdate(0);
            }, [sessionId, onScoreUpdate]);

            // --- 2e. Game Loop ---
            const loop = useCallback(() => {
                if (status !== 'PLAYING') return;
                
                const state = gameState.current;
                const { player } = state;
                const keys = keysRef.current;
                frameCountRef.current++;
                const fc = frameCountRef.current;

                // Spawners
                if (fc % 100 === 0) { // Trash
                    const types = ['TRASH_BOTTLE', 'TRASH_TIRE', 'TRASH_BAG', 'TRASH_BOOT'];
                    const type = types[Math.floor(Math.random()*types.length)];
                    state.entities.push({
                        type, id: Math.random(), 
                        x: LOGICAL_WIDTH + 50, 
                        y: Math.random() * (LOGICAL_HEIGHT - 300) + 100, // Safe zone
                        w: 60, h: 60, 
                        vx: -2 - Math.random(), vy: 0, 
                        asset: type
                    });
                }
                if (fc % 180 === 0) { // Enemies
                    const types = ['ENEMY_JELLYFISH', 'ENEMY_SHARK'];
                    const type = types[Math.floor(Math.random()*types.length)];
                    const isShark = type === 'ENEMY_SHARK';
                    state.entities.push({
                        type, id: Math.random(), 
                        x: LOGICAL_WIDTH + 50, 
                        y: Math.random() * (LOGICAL_HEIGHT - 300) + 100,
                        w: isShark ? 150 : 60, h: isShark ? 60 : 60,
                        vx: isShark ? -4 - Math.random() : -2, 
                        vy: isShark ? 0 : Math.sin(fc/50)*0.5,
                        asset: type
                    });
                }
                
                // Decorations
                if (fc >= nextDecoSpawnRef.current) { 
                    const algae = ['DECO_ALGA_1', 'DECO_ALGA_2', 'DECO_ALGA_3'];
                    const corals = ['DECO_CORAL_1', 'DECO_CORAL_2', 'DECO_CORAL_3', 'DECO_CORAL_4', 'DECO_CORAL_5'];
                    const rocks = ['DECO_ROCK_1'];
                    const allDecos = [...algae, ...corals, ...rocks];
                    const assetKey = allDecos[Math.floor(Math.random()*allDecos.length)];
                    
                    let w = 50, h = 50;
                    if (algae.includes(assetKey)) { w = 40; h = 70; }
                    else if (rocks.includes(assetKey)) { w = 70; h = 45; }
                    else if (corals.includes(assetKey)) { w = 60; h = 60; }

                    state.decorations.push({
                         id: Math.random(), 
                         x: LOGICAL_WIDTH + 50, 
                         y: LOGICAL_HEIGHT - h - 30 + (Math.random()*10),
                         w: w, h: h, 
                         vx: -1.5, 
                         asset: assetKey
                    });
                    nextDecoSpawnRef.current = fc + Math.floor(Math.random() * 80) + 40;
                }

                // Ambient Bubbles
                if (fc % 15 === 0) {
                     state.particles.push({
                        x: Math.random() * LOGICAL_WIDTH, 
                        y: LOGICAL_HEIGHT + 10, 
                        vx: 0, vy: -1 - Math.random()*2, 
                        life: 200, color: COLORS.BUBBLE, w: 2 + Math.random()*3, h: 2 + Math.random()*3
                    });
                }

                // Physics
                let swim = false;
                if (keys.has('ArrowUp') || keys.has(' ') || keys.has('w')) swim = true;
                
                let dx = 0;
                if (keys.has('ArrowLeft') || keys.has('a')) dx = -1;
                if (keys.has('ArrowRight') || keys.has('d')) dx = 1;

                if (swim) {
                    player.vy += SWIM_FORCE * 0.15;
                    // Player Bubbles
                    if (fc % 5 === 0) state.particles.push({
                        x: player.x + (facingRef.current === 'RIGHT' ? 0 : player.width), 
                        y: player.y + 40, 
                        vx: (Math.random()-0.5)*2, vy: 1, 
                        life: 20, color: 'rgba(255,255,255,0.5)', w:6, h:6
                    });
                }

                if (dx !== 0) {
                    player.vx += dx * 0.5;
                    facingRef.current = dx > 0 ? 'RIGHT' : 'LEFT';
                }

                player.vy += GRAVITY;
                player.vx *= FRICTION;
                player.vy *= FRICTION;

                player.x += player.vx;
                player.y += player.vy;
                
                // Boundaries
                if (player.y < 0) { player.y = 0; player.vy = 0; }
                if (player.y > LOGICAL_HEIGHT - player.height - 40) { player.y = LOGICAL_HEIGHT - player.height - 40; player.vy = 0; }
                if (player.x < 0) { player.x = 0; player.vx = 0; }
                if (player.x > LOGICAL_WIDTH - player.width) { player.x = LOGICAL_WIDTH - player.width; player.vx = 0; }

                if (player.invincible > 0) player.invincible--;

                // Entity Logic
                state.entities.forEach(e => {
                    e.x += e.vx;
                    e.y += e.vy;

                    // Particles for enemies
                    if (e.asset === 'ENEMY_SHARK' && fc % 4 === 0) {
                        state.particles.push({
                            x: e.x + e.w - 10, y: e.y + e.h / 2,
                            vx: 2, vy: (Math.random() - 0.5) * 2,
                            life: 25, color: 'rgba(255,255,255,0.4)', w: 5, h: 5
                        });
                    } else if (e.asset === 'ENEMY_JELLYFISH' && fc % 15 === 0) {
                         state.particles.push({
                            x: e.x + e.w / 2, y: e.y + e.h - 10,
                            vx: 0, vy: 1, life: 40, color: 'rgba(255,255,255,0.3)', w: 3, h: 3
                        });
                    }
                    
                    // Collision
                    if (
                        player.x < e.x + e.w - 15 &&
                        player.x + player.width > e.x + 15 &&
                        player.y < e.y + e.h - 15 &&
                        player.y + player.height > e.y + 15
                    ) {
                        if (e.type.startsWith('TRASH')) {
                            e.delete = true;
                            state.score += 10;
                            onScoreUpdate(state.score);
                            playSfx('COLLECT'); 
                            
                            let pColor = '#fff';
                            if (e.type.includes('TIRE')) pColor = '#1f2937'; 
                            else if (e.type.includes('BOOT')) pColor = '#78350f';
                            else if (e.type.includes('BAG')) pColor = '#9ca3af';
                            else if (e.type.includes('BOTTLE')) pColor = '#3b82f6';

                            for(let i=0; i<8; i++) state.particles.push({
                                x: e.x + e.w/2, y: e.y + e.h/2, 
                                vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12, 
                                life: 30, color: pColor, w: 8, h:8
                            });
                        } else if (e.type.startsWith('ENEMY') && player.invincible === 0) {
                            playSfx('EXPLOSION');
                            onGameOver(state.score);
                        }
                    }
                    if (e.x < -150) e.delete = true;
                });

                state.decorations.forEach(d => {
                    d.x += d.vx;
                    if (d.x < -100) d.delete = true;
                });

                state.particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.life--;
                });

                // Cleanup
                state.entities = state.entities.filter(e => !e.delete);
                state.decorations = state.decorations.filter(d => !d.delete);
                state.particles = state.particles.filter(p => p.life > 0);

            }, [status, onScoreUpdate, onGameOver, playSfx]);

            // --- 2f. Draw Loop ---
            const draw = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const state = gameState.current;

                ctx.clearRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
                ctx.imageSmoothingEnabled = false;
                
                // Gradient Background
                const grad = ctx.createLinearGradient(0, 0, 0, LOGICAL_HEIGHT);
                grad.addColorStop(0, COLORS.BRAND_BLUE_LIGHT);
                grad.addColorStop(1, COLORS.BRAND_BLUE_DARK);
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);

                // Parallax BG
                if (images['BG_LAYER']) {
                    const scrollSpeed = 0.5;
                    const bgX = -(frameCountRef.current * scrollSpeed) % LOGICAL_WIDTH;
                    // Draw twice for infinite loop, overlap by 2px to fix gap
                    ctx.drawImage(images['BG_LAYER'], Math.floor(bgX), 0, LOGICAL_WIDTH + 2, LOGICAL_HEIGHT);
                    ctx.drawImage(images['BG_LAYER'], Math.floor(bgX) + LOGICAL_WIDTH - 2, 0, LOGICAL_WIDTH + 2, LOGICAL_HEIGHT);
                }

                // Floor
                ctx.fillStyle = COLORS.SAND;
                ctx.fillRect(0, LOGICAL_HEIGHT - 40, LOGICAL_WIDTH, 40);

                // Decorations
                state.decorations.forEach(d => {
                    if (images[d.asset]) ctx.drawImage(images[d.asset], d.x, d.y, d.w, d.h);
                });

                // Entities
                state.entities.forEach(e => {
                    if (images[e.asset]) {
                        ctx.drawImage(images[e.asset], e.x, e.y, e.w, e.h);
                    } else {
                        ctx.fillStyle = 'red'; ctx.fillRect(e.x, e.y, e.w, e.h);
                    }
                });

                // Particles
                state.particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.w, p.h);
                });

                // Player DOM Overlay Sync
                const p = state.player;
                if (domPlayerRef.current) {
                    const domEl = domPlayerRef.current;
                    if (status === 'PLAYING' || status === 'PAUSED') {
                        domEl.style.display = 'block';
                        
                        // Use Percentage for Responsive Positioning
                        const leftPct = (p.x / LOGICAL_WIDTH) * 100;
                        const topPct = (p.y / LOGICAL_HEIGHT) * 100;
                        const wPct = (p.width / LOGICAL_WIDTH) * 100;
                        const hPct = (p.height / LOGICAL_HEIGHT) * 100;

                        domEl.style.left = `${leftPct}%`;
                        domEl.style.top = `${topPct}%`;
                        domEl.style.width = `${wPct}%`;
                        domEl.style.height = `${hPct}%`;
                        
                        const scaleX = facingRef.current === 'LEFT' ? -1 : 1;
                        domEl.style.transform = `scaleX(${scaleX})`;
                        
                        domEl.style.opacity = (p.invincible > 0 && Math.floor(Date.now()/100)%2 !== 0) ? '0.5' : '1';
                    } else {
                        domEl.style.display = 'none';
                    }
                }

            }, [images, status]);

            // Animation Loop
            useEffect(() => {
                const animate = () => {
                    loop();
                    draw();
                    requestRef.current = requestAnimationFrame(animate);
                };
                requestRef.current = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(requestRef.current);
            }, [loop, draw]);

            return (
                <div className="relative w-full h-full bg-black overflow-hidden shadow-2xl">
                    <canvas 
                        ref={canvasRef} 
                        width={LOGICAL_WIDTH} 
                        height={LOGICAL_HEIGHT}
                        style={{ width: '100%', height: '100%', objectFit: 'fill' }}
                    />
                    <img 
                        ref={domPlayerRef}
                        src={GAME_ASSETS.PLAYER}
                        className="absolute pointer-events-none hidden"
                        alt="Player"
                        style={{
                            imageRendering: 'pixelated', 
                            willChange: 'left, top, transform'
                        }}
                    />
                </div>
            );
        };

        // ==========================================
        // 3. COMPONENT: APP (UI & CONTROLS)
        // ==========================================

        const App = () => {
            const [status, setStatus] = useState('START');
            const [score, setScore] = useState(0);
            const [highScore, setHighScore] = useState(0);
            const [gameOverMsg, setGameOverMsg] = useState(null);
            const [sessionId, setSessionId] = useState(0); 
            
            // Audio Refs
            const musicRef = useRef(new Audio(GAME_ASSETS.MUSIC_BG));
            const sfxCollectRef = useRef(new Audio(GAME_ASSETS.SFX_COLLECT));
            const sfxExplosionRef = useRef(new Audio(GAME_ASSETS.SFX_EXPLOSION));

            // Init Audio
            useEffect(() => {
                musicRef.current.loop = true;
                musicRef.current.volume = 0.4;
                sfxCollectRef.current.volume = 0.6;
                sfxExplosionRef.current.volume = 0.7;
            }, []);

            // Audio Logic
            useEffect(() => {
                const music = musicRef.current;
                if (status === 'PLAYING') {
                    music.play().catch(e => console.log("Audio play blocked until interaction"));
                } else if (status === 'PAUSED') {
                    music.pause();
                } else if (status === 'GAME_OVER' || status === 'START') {
                    music.pause();
                    music.currentTime = 0;
                }
            }, [status]);
            
            const playSfx = useCallback((type) => {
                if (type === 'COLLECT') {
                    sfxCollectRef.current.currentTime = 0;
                    sfxCollectRef.current.play().catch(e=>{});
                } else if (type === 'EXPLOSION') {
                    sfxExplosionRef.current.currentTime = 0;
                    sfxExplosionRef.current.play().catch(e=>{});
                }
            }, []);

            // Input Event Emitter for Controls
            const emitInput = (key, type) => {
                const event = new CustomEvent(type === 'down' ? 'game-input-down' : 'game-input-up', { detail: { key } });
                window.dispatchEvent(event);
            };

            const handleStart = useCallback(() => {
                setSessionId(prev => prev + 1); 
                setStatus('PLAYING');
                setScore(0);
            }, []);

            const handleGameOver = useCallback((finalScore) => {
                setStatus('GAME_OVER');
                setHighScore(h => Math.max(h, finalScore));
                const msg = CUSTOM_MESSAGES[Math.floor(Math.random() * CUSTOM_MESSAGES.length)];
                setGameOverMsg(msg);
            }, []);

            const togglePause = () => {
                if (status === 'PLAYING') setStatus('PAUSED');
                else if (status === 'PAUSED') setStatus('PLAYING');
            };

            const resetGame = () => {
                setSessionId(prev => prev + 1); 
                setScore(0);
                setStatus('PLAYING');
            };

            return (
                <div className="w-full h-full bg-slate-900 flex justify-center items-center overflow-hidden font-pixel select-none">
                    
                    {/* CONTAINER */}
                    <div 
                        className="relative h-full w-full mx-auto bg-black shadow-2xl overflow-hidden ring-4 ring-black/20"
                        style={{ maxWidth: '56.25vh' }}
                        onClick={() => { if (status === 'PLAYING' || status === 'PAUSED') togglePause(); }}
                    >
                        
                        {/* 1. GAME LAYER */}
                        <div className="absolute inset-0 z-0 bg-[#0369a1]">
                            <GameCanvas 
                                sessionId={sessionId}
                                status={status}
                                onScoreUpdate={setScore}
                                onGameOver={handleGameOver}
                                playSfx={playSfx}
                            />
                        </div>

                        {/* 2. SCANLINE OVERLAY */}
                        <div className="scanline z-10 opacity-30 pointer-events-none"></div>

                        {/* 3. HUD (TOP) */}
                        <div className="absolute top-8 left-0 right-0 z-20 px-4 pointer-events-none">
                            {/* PIXEL CONTAINER: OUTER (Yellow Border) */}
                            <div className="relative bg-[#facc15] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)] pointer-events-auto">
                                {/* PIXEL CONTAINER: INNER (Red Bg) */}
                                <div className="bg-[#b91c1c] h-12 flex items-center justify-between px-4 text-white w-full pixel-clip">
                                    <div className="flex items-center gap-2">
                                        <Trash2 className="w-4 h-4 text-[#facc15]" />
                                        <span className="text-sm font-bold tracking-widest text-shadow-retro">{score.toString().padStart(5,'0')}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <Award className="w-4 h-4 text-[#facc15]" />
                                        <span className="text-sm font-bold tracking-widest text-shadow-retro">{highScore.toString().padStart(5,'0')}</span>
                                    </div>
                                </div>
                            </div>

                            {/* LOGO (Floating) */}
                            <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 h-20 w-32 flex items-center justify-center pointer-events-none">
                                <img 
                                    src={GAME_ASSETS.LOGO} 
                                    alt="Marinero Logo" 
                                    className="h-16 object-contain drop-shadow-xl z-10 animate-logo-pulse"
                                />
                            </div>
                        </div>

                        {/* 4. CONTROLS (BOTTOM) */}
                        {(status === 'PLAYING' || status === 'PAUSED') && (
                            <div className="absolute bottom-0 left-0 right-0 z-30 p-4 pb-8 flex justify-between items-end pointer-events-none select-none">
                                {/* D-PAD */}
                                <div 
                                    className="flex gap-4 pointer-events-auto"
                                    onClick={(e) => e.stopPropagation()} 
                                >
                                    {/* LEFT BUTTON */}
                                    <div className="btn-pixel-wrapper w-16 h-16 md:w-20 md:h-20 active:translate-y-1 transition-transform touch-manipulation">
                                        <div 
                                            className="w-full h-full bg-[#ca8a04] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]"
                                            onTouchStart={(e) => { e.preventDefault(); emitInput('ArrowLeft', 'down'); }}
                                            onTouchEnd={(e) => { e.preventDefault(); emitInput('ArrowLeft', 'up'); }}
                                            onMouseDown={() => emitInput('ArrowLeft', 'down')}
                                            onMouseUp={() => emitInput('ArrowLeft', 'up')}
                                            onMouseLeave={() => emitInput('ArrowLeft', 'up')}
                                        >
                                            <div className="pixel-inner w-full h-full bg-[#facc15] pixel-clip flex items-center justify-center transition-transform">
                                                <ChevronLeft className="w-10 h-10 text-[#b91c1c]" strokeWidth={4} />
                                            </div>
                                        </div>
                                    </div>

                                    {/* RIGHT BUTTON */}
                                    <div className="btn-pixel-wrapper w-16 h-16 md:w-20 md:h-20 active:translate-y-1 transition-transform touch-manipulation">
                                        <div 
                                            className="w-full h-full bg-[#ca8a04] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]"
                                            onTouchStart={(e) => { e.preventDefault(); emitInput('ArrowRight', 'down'); }}
                                            onTouchEnd={(e) => { e.preventDefault(); emitInput('ArrowRight', 'up'); }}
                                            onMouseDown={() => emitInput('ArrowRight', 'down')}
                                            onMouseUp={() => emitInput('ArrowRight', 'up')}
                                            onMouseLeave={() => emitInput('ArrowRight', 'up')}
                                        >
                                            <div className="pixel-inner w-full h-full bg-[#facc15] pixel-clip flex items-center justify-center transition-transform">
                                                <ChevronRight className="w-10 h-10 text-[#b91c1c]" strokeWidth={4} />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* ACTION BUTTON */}
                                <div 
                                    className="pointer-events-auto"
                                    onClick={(e) => e.stopPropagation()} 
                                >
                                    <div className="btn-pixel-wrapper w-20 h-20 md:w-24 md:h-24 active:translate-y-1 transition-transform touch-manipulation">
                                        <div 
                                            className="w-full h-full bg-[#7f1d1d] p-1 pixel-clip shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]"
                                            onTouchStart={(e) => { e.preventDefault(); emitInput(' ', 'down'); }}
                                            onTouchEnd={(e) => { e.preventDefault(); emitInput(' ', 'up'); }}
                                            onMouseDown={() => emitInput(' ', 'down')}
                                            onMouseUp={() => emitInput(' ', 'up')}
                                            onMouseLeave={() => emitInput(' ', 'up')}
                                        >
                                            <div className="pixel-inner w-full h-full bg-[#b91c1c] pixel-clip flex flex-col items-center justify-center transition-transform">
                                                <ArrowUp className="w-10 h-10 text-white mb-1" strokeWidth={4} />
                                                <span className="text-[10px] font-bold text-[#facc15] text-shadow-retro">NADAR</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 5. SCREENS (START / PAUSE / GAME OVER) */}
                        {status !== 'PLAYING' && (
                            <div 
                                className="absolute inset-0 z-40 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm"
                                onClick={(e) => {
                                    if (status === 'PAUSED') togglePause();
                                }}
                            >
                                {/* PAUSE SCREEN */}
                                {status === 'PAUSED' && (
                                    <div className="flex flex-col items-center animate-in fade-in zoom-in duration-200 pointer-events-none">
                                        <h2 className="text-6xl text-[#facc15] font-bold text-shadow-retro mb-4 animate-pulse">PAUSA</h2>
                                        <p className="text-white text-xl text-shadow-retro animate-bounce">TOCA PARA CONTINUAR</p>
                                    </div>
                                )}

                                {/* START SCREEN */}
                                {status === 'START' && (
                                    <div 
                                        className="w-full max-w-xs animate-in zoom-in duration-300"
                                        onClick={(e) => e.stopPropagation()}
                                    >
                                        <div className="bg-[#facc15] p-1 pixel-clip shadow-[8px_8px_0px_0px_rgba(0,0,0,0.5)]">
                                            <div className="bg-[#b91c1c] p-1 pixel-clip">
                                                <div className="bg-[#0f172a] p-6 text-center flex flex-col items-center pixel-clip">
                                                    <img 
                                                        src={GAME_ASSETS.LOGO} 
                                                        alt="Marinero" 
                                                        className="w-48 object-contain mb-6 animate-pulse"
                                                    />
                                                    
                                                    <div className="w-full bg-blue-900/50 p-4 mb-6 border-2 border-dashed border-blue-500/30 text-xs text-blue-100 leading-relaxed">
                                                        <p className="mb-2">ðŸŒŠ Â¡El mar estÃ¡ lleno de basura!</p>
                                                        <p>Ayuda al pez Marinero a recolectar botellas y evitar medusas y tiburones.</p>
                                                    </div>

                                                    <button 
                                                        onClick={handleStart}
                                                        className="btn-pixel-wrapper w-full group active:translate-y-1 transition-transform"
                                                    >
                                                        <div className="bg-[#b91c1c] p-1 pixel-clip shadow-[4px_4px_0px_0px_#a16207]">
                                                            <div className="pixel-inner bg-[#facc15] py-4 text-[#b91c1c] font-bold text-lg pixel-clip flex items-center justify-center gap-2 group-hover:bg-yellow-300">
                                                                <Play className="fill-current w-5 h-5" />
                                                                Â¡AL AGUA!
                                                            </div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* GAME OVER SCREEN */}
                                {status === 'GAME_OVER' && (
                                    <div 
                                        className="w-full max-w-xs animate-in slide-in-from-bottom duration-500"
                                        onClick={(e) => e.stopPropagation()}
                                    >
                                        <div className="bg-[#0369a1] p-1 pixel-clip shadow-[8px_8px_0px_0px_rgba(0,0,0,0.5)]">
                                            <div className="bg-white p-1 pixel-clip">
                                                <div className="bg-[#f0f9ff] p-6 text-center flex flex-col items-center pixel-clip">
                                                    <img 
                                                        src={GAME_ASSETS.LOGO} 
                                                        alt="Marinero" 
                                                        className="h-16 object-contain mb-4 animate-bounce"
                                                    />
                                                    
                                                    <h2 className="text-2xl text-[#0369a1] font-bold mb-4 text-shadow-retro">Â¡OH NO!</h2>
                                                    
                                                    <div className="w-full bg-[#b91c1c] p-1 pixel-clip mb-6 shadow-sm transform -rotate-1">
                                                        <div className="bg-white p-4 pixel-clip">
                                                            <div className="text-xs text-slate-500 font-bold uppercase mb-1">PuntuaciÃ³n Final</div>
                                                            <div className="text-4xl font-black text-[#b91c1c] text-shadow-retro">{score}</div>
                                                        </div>
                                                    </div>

                                                    {gameOverMsg && (
                                                        <div className="mb-6">
                                                            <div className="text-[#0369a1] font-bold text-sm uppercase border-b-2 border-blue-200 pb-1 mb-2">
                                                                {gameOverMsg.title}
                                                            </div>
                                                            <p className="text-xs text-slate-600 italic leading-relaxed">
                                                                "{gameOverMsg.message}"
                                                            </p>
                                                        </div>
                                                    )}

                                                    <button 
                                                        onClick={resetGame}
                                                        className="btn-pixel-wrapper w-full group active:translate-y-1 transition-transform"
                                                    >
                                                        <div className="bg-white p-1 pixel-clip shadow-[4px_4px_0px_0px_#7f1d1d]">
                                                            <div className="pixel-inner bg-[#b91c1c] py-4 text-white font-bold text-lg pixel-clip flex items-center justify-center gap-2 group-hover:bg-red-600">
                                                                <RotateCcw className="w-5 h-5" />
                                                                REINTENTAR
                                                            </div>
                                                        </div>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
